---
title: 追踪
description: Learn how to trace your agent runs
---

import { Aside, Code } from '@astrojs/starlight/components';
import customTraceExample from '../../../../../../examples/docs/custom-trace.ts?raw';
import cloudflareWorkers from '../../../../../../examples/docs/tracing/cloudflareWorkers.ts?raw';

Agents SDK 内置了追踪功能，可在智能体运行期间收集全面的事件记录：LLM 生成、工具调用、交接、护栏，以及自定义事件。使用 [Traces 仪表板](https://platform.openai.com/traces)，你可以在开发和生产环境中调试、可视化并监控工作流。

<Aside type="note">

追踪默认启用。禁用追踪有两种方式：

1. 通过设置环境变量 `OPENAI_AGENTS_DISABLE_TRACING=1` 全局禁用追踪
2. 为单次运行设置 [`RunConfig.tracingDisabled`](/openai-agents-js/openai/agents-core/type-aliases/runconfig/#tracingdisabled) 为 `true` 以禁用追踪

**_对于使用 OpenAI 的 API 且遵循 Zero Data Retention (ZDR) 策略的组织，不提供追踪功能。_**

</Aside>

## 导出循环生命周期

在大多数环境中，追踪会按固定时间间隔自动导出。在浏览器或 Cloudflare Workers 中，此功能默认关闭。若队列中累计过多，追踪仍会被导出，但不会定期导出。你应使用 `getGlobalTraceProvider().forceFlush()` 将导出追踪作为代码生命周期的一部分手动触发。

例如，在 Cloudflare Worker 中，应将代码包裹在 `try/catch/finally` 中，并结合 `waitUntil` 使用强制刷新，以确保在 worker 退出前导出追踪。

<Code
  lang="typescript"
  code={cloudflareWorkers.replace(/\s+\/\/ @ts-expect-error.*$/m, '')}
  meta="{13}"
/>

## Trace 与 Span

- **Traces** 表示一次“工作流”的端到端操作。它们由多个 Span 组成。Trace 具有以下属性：
  - `workflow_name`：逻辑工作流或应用。例如 "Code generation" 或 "Customer service"。
  - `trace_id`：Trace 的唯一 ID。如果未传入会自动生成。必须符合格式 `trace_<32_alphanumeric>`。
  - `group_id`：可选的分组 ID，用于关联同一会话中的多个 Trace。例如可使用聊天线程 ID。
  - `disabled`：若为 True，则不会记录该 Trace。
  - `metadata`：Trace 的可选元数据。
- **Spans** 表示具有开始和结束时间的操作。Span 具有：
  - `started_at` 和 `ended_at` 时间戳。
  - `trace_id`，表示其所属的 Trace
  - `parent_id`，指向该 Span 的父 Span（如果有）
  - `span_data`，关于该 Span 的信息。例如，`AgentSpanData` 包含智能体信息，`GenerationSpanData` 包含 LLM 生成信息等。

## 默认追踪

默认情况下，SDK 会追踪以下内容：

- 整个 `run()` 或 `Runner.run()` 会被 `Trace` 包裹
- 每次智能体运行都会被 `AgentSpan` 包裹
- LLM 生成会被 `GenerationSpan` 包裹
- 函数工具调用会分别被 `FunctionSpan` 包裹
- 护栏会被 `GuardrailSpan` 包裹
- 交接会被 `HandoffSpan` 包裹

默认情况下，Trace 名称为 "Agent workflow"。如果你使用 `withTrace`，可以设置该名称；或者可通过 [`RunConfig.workflowName`](/openai-agents-js/openai/agents-core/type-aliases/runconfig/#workflowname) 配置名称及其他属性。

此外，你可以设置[自定义追踪处理器](#custom-tracing-processors)，将追踪数据推送到其他目的地（作为替代或次要目标）。

### 语音智能体追踪

如果你在使用 `RealtimeAgent` 和 `RealtimeSession` 搭配默认的 OpenAI Realtime API，追踪将默认在 Realtime API 侧自动进行，除非你在 `RealtimeSession` 上通过 `tracingDisabled: true` 或设置 `OPENAI_AGENTS_DISABLE_TRACING` 环境变量禁用它。

查看[语音智能体概述](/openai-agents-js/zh/guides/voice-agents)了解更多详情。

## 更高层级的 Trace

有时你可能希望多次调用 `run()` 属于同一个 Trace。可以通过将整个代码包裹在 `withTrace()` 中实现。

<Code lang="typescript" code={customTraceExample} />

1. 因为两次对 `run` 的调用都包裹在 `withTrace()` 中，单次运行将作为整体 Trace 的一部分，而不会创建两个独立的 Trace。

## 创建 Trace

你可以使用 [`withTrace()`](/openai-agents-js/openai/agents-core/functions/withtrace/) 函数创建一个 Trace。或者，你也可以使用 `getGlobalTraceProvider().createTrace()` 手动创建新的 Trace，并将其传入 `withTrace()`。

当前 Trace 通过 [Node.js `AsyncLocalStorage`](https://nodejs.org/api/async_context.html#class-asynclocalstorage) 或相应环境的 polyfill 进行追踪。这意味着它可自动适配并发。

## 创建 Span

你可以使用各种 `create*Span()`（例如 `createGenerationSpan()`、`createFunctionSpan()` 等）方法创建 Span。通常无需手动创建 Span。提供了一个 [`createCustomSpan()`](/openai-agents-js/openai/agents-core/functions/createcustomspan/) 函数用于追踪自定义 Span 信息。

Span 会自动归属到当前 Trace 下，并嵌套在最近的当前 Span 之下，该状态通过 [Node.js `AsyncLocalStorage`](https://nodejs.org/api/async_context.html#class-asynclocalstorage) 或相应环境的 polyfill 进行追踪。

## 敏感数据

某些 Span 可能会捕获潜在的敏感数据。

`createGenerationSpan()` 会存储 LLM 生成的输入/输出，`createFunctionSpan()` 会存储函数调用的输入/输出。这些可能包含敏感数据，因此你可以通过 [`RunConfig.traceIncludeSensitiveData
`](/openai-agents-js/openai/agents-core/type-aliases/runconfig/#traceincludesensitivedata) 禁用对这些数据的采集。

## 自定义追踪处理器

追踪的高层架构为：

- 在初始化时，我们会创建一个全局的 [`TraceProvider`](/openai-agents-js/openai/agents-core/classes/traceprovider)，负责创建 Trace，并可通过 [`getGlobalTraceProvider()`](/openai-agents-js/openai/agents-core/functions/getglobaltraceprovider/) 访问。
- 我们将 `TraceProvider` 配置为使用 [`BatchTraceProcessor`](/openai-agents-js/openai/agents-core/classes/batchtraceprocessor/)，以批处理形式将 Trace/Span 发送到 [`OpenAITracingExporter`](/openai-agents-js/openai/agents-openai/classes/openaitracingexporter/)，由其批量将 Span 和 Trace 导出到 OpenAI 后端。

如需自定义默认设置，将追踪发送到其他或额外的后端，或修改导出器行为，你有两种选择：

1. [`addTraceProcessor()`](/openai-agents-js/openai/agents-core/functions/addtraceprocessor) 允许你添加一个“额外的”追踪处理器，它会在追踪与 Span 就绪时接收它们。这使你可以在将追踪发送到 OpenAI 后端之外，执行自定义处理。
2. [`setTraceProcessors()`](/openai-agents-js/openai/agents-core/functions/settraceprocessors) 允许你“替换”默认处理器为自定义追踪处理器。这意味着除非你包含一个将数据发送到 OpenAI 的 `TracingProcessor`，否则追踪将不会发送到 OpenAI 后端。

## 外部追踪处理器列表

- [AgentOps](https://docs.agentops.ai/v2/usage/typescript-sdk#openai-agents-integration)
- [Keywords AI](https://docs.keywordsai.co/integration/development-frameworks/openai-agents-sdk-js)
